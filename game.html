<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å­—æˆèªæš¨è©å½™æŸ¥è©¢ç³»çµ± - æˆèªæ“‚å°æŒ‘æˆ°è³½ï½œæ¼«æ­¥æ™‚å…‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- nav -->
    <link rel="stylesheet" href="nav.css">
    <script src="nav.js"></script>

    <!-- style -->
    <link rel="stylesheet" href="game.css">

    <style>
        :root {
            --accent-red: #a63d33;      /* å„ªé›…ç´… */
            --accent-blue: #34495e;     /* æ·±é‚ƒè— */
            --accent-gold: #c6a355;     /* å¤å…¸é‡‘ */
            --bg-paper: #f9f7f2;        /* ç´™å¼µè‰² */
            --border-color: #e0ddd5;
            --text-main: #2c3e50;
            --serif: 'Noto Serif TC', serif;
            --sans: 'Noto Sans TC', sans-serif;
        }

        body { 
            background-color: var(--bg-paper); 
            color: var(--text-main); 
            line-height: 1.6;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            width: 95%;
            max-width: 600px;
            margin: 15px auto;
            text-align: center;
            box-sizing: border-box;
        }

        /* æ–‡å­—èªªæ˜å€å¡Š */
        .art-intro {
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.8;
            font-family: var(--serif);
        }
        .art-intro span {
            display: block;
        }

        .rules-small {
            margin-top: 25px;
            font-size: 0.85rem;
            color: #95a5a6;
            line-height: 1.6;
            border-top: 1px solid #f0ede5;
            padding-top: 15px;
        }

        /* ç‹€æ…‹åˆ— */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            background: #fcfbf9;
            padding: 12px 5px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f0ede5;
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; border-right: 1px solid #eee; }
        .stat-item:last-child { border-right: none; }
        .stat-label { font-size: 0.7rem; color: #999; margin-bottom: 2px; }
        .stat-value { font-weight: 600; color: var(--accent-blue); font-size: 0.9rem; }

        /* è¨ˆæ™‚æ¢ */
        #timer-container { height: 3px; background: #eee; border-radius: 1px; margin-bottom: 20px; overflow: hidden; }
        #timer-bar { height: 100%; background: var(--accent-red); transition: width 0.1s linear; }

        /* æˆèªæ–¹å¡Šç°¡ç´„åŒ– */
        .idiom-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            max-width: 360px;
            margin: 0 auto 20px;
        }
        
        .char-box {
            aspect-ratio: 1;
            border: 1.5px solid #eae7e0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-family: var(--serif);
            font-weight: 600;
            background: #fff;
            transition: all 0.3s ease;
        }

        .char-box:not(:has(input)) {
            background: #f8f6f2;
            color: #7f8c8d;
            border-color: #e5e2da;
        }

        .game-input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1.8rem;
            font-family: var(--serif);
            font-weight: 700;
            color: var(--accent-red);
            outline: none;
            background: #fffdf5;
            transition: background 0.2s;
        }
        
        .game-input:focus {
            background: #fff;
        }
        .char-box:has(.game-input:focus) {
            border-color: var(--accent-gold);
            box-shadow: 0 0 8px rgba(198, 163, 85, 0.1);
        }

        /* å‹•ä½œæŒ‰éˆ• */
        .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .btn {
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-family: var(--serif);
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 0.95rem;
        }
        .btn-primary { background: var(--accent-red); color: white; }
        .btn-tool { background: var(--accent-gold); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #999; }
        .btn:hover { opacity: 0.85; }

        /* è¨Šæ¯æç¤º */
        #msg { min-height: 1.8em; margin-bottom: 8px; font-weight: bold; font-size: 0.95rem; }

        /* --- è§£ç­”å½ˆçª— Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            width: 90%;
            max-width: 480px;
            border-radius: 8px;
            position: relative;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalSlide 0.3s ease-out;
            box-sizing: border-box;
        }
        @keyframes modalSlide { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-close {
            position: absolute;
            top: 12px; right: 12px;
            background: none; border: none;
            font-size: 1.4rem; color: #ccc;
            cursor: pointer; transition: color 0.2s;
        }
        .modal-close:hover { color: var(--accent-red); }

        .modal-header {
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            padding-bottom: 8px;
            text-align: left;
        }
        .modal-body {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            padding-right: 8px;
        }
        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .idiom-list-item { margin-bottom: 12px; }
        .idiom-title { font-weight: 700; color: var(--accent-red); font-size: 1.1rem; display: block; margin-bottom: 3px; }
        .idiom-def { font-size: 0.9rem; color: #555; }

        /* çå‹µå¡ */
        .reward-badge { display: inline-block; background: #fdfaf5; border: 1px solid #eee; padding: 10px 18px; border-radius: 4px; margin: 5px; font-weight: bold; }

        /* çµèªç•«é¢å„ªåŒ– */
        #scene-end .game-card { padding: 30px 15px; }
        canvas { 
            max-width: 100%; 
            height: auto; 
            border: 1px solid #f0ede5; 
            margin: 10px 0;
            display: block;
        }
    </style>
</head>
<body>

    <!-- é–‹å§‹ä»‹é¢ -->
    <div id="scene-start" class="scene active">
        <div class="game-card">
            <h1 style="color: var(--accent-red); font-family: var(--serif); font-size: 2.3rem; margin-bottom: 12px; font-weight: 700;">æˆèªæ“‚å°æŒ‘æˆ°è³½</h1>
            
            <div class="art-intro">
                <span>æ–‡æµ·æµ®æ²ˆï¼Œå¢¨éŸ»ç•™é¦™ã€‚</span>
                <span>ä¸€å­—ä¸€å¥ï¼Œçš†æ˜¯åƒè¼‰æ™ºæ…§ä¹‹çµæ™¶ã€‚</span>
                <span>é‚€å›åŸ·ç­†ï¼Œå…±èµ´é€™å ´æ–‡å­—æ“‚å°è³½ã€‚</span>
            </div>

            <div style="margin: 20px 0;">
                <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„åè™Ÿ" maxlength="8" style="padding:12px; text-align:center; font-size:1.1rem; border:1px solid var(--border-color); border-radius:4px; width: 220px; outline: none; font-family: var(--serif);">
            </div>
            
            <button class="btn btn-primary" onclick="startGame()">é³´é‘¼é–‹æˆ°</button>

            <div class="rules-small">
                é–‹æ”¾å¼å¡«ç©ºï¼šéš¨è‘—é¡Œæ•¸å¢åŠ ï¼ŒæŒ‘æˆ°é›£åº¦å°‡é€æ¼¸æ”€å‡ã€‚<br>
                è€ƒé©—æ‰‹è…¦ä¸¦ç”¨ï¼šè¨ˆæ™‚å™¨æŒçºŒé‹è¡Œï¼Œå¯é»æ“Šå»¶æ™‚é“å…·è£œå……æ™‚é–“ã€‚<br>
                <span style="color: var(--accent-red);">â€» ç«¶è³½æœŸé–“è«‹å°ˆæ³¨ç•«é¢ï¼Œä»»ä½•è¦–çª—å¤§å°è®Šæ›´æˆ–é›¢é–‹ç„¦é»å°‡è¦–ç‚ºä½œå¼Šã€‚</span>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²ä¸»ä»‹é¢ -->
    <div id="scene-game" class="scene">
        <div class="game-card">
            <div class="stats-dashboard">
                <div class="stat-item">
                    <span class="stat-label">æŒ‘æˆ°è€…</span>
                    <span class="stat-value" id="display-name">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å‹å ´</span>
                    <span class="stat-value">ğŸ† <span id="score">0</span></span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å…ƒæ°£</span>
                    <span class="stat-value" id="hp-display">â¤ï¸ x3</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">é“å…·</span>
                    <span class="stat-value" id="clock-display">â³ x3</span>
                </div>
            </div>

            <div id="timer-container"><div id="timer-bar"></div></div>
            
            <p id="potential-count" style="font-size: 0.8rem; color: #bbb; margin-bottom: 12px; font-family: var(--sans);"></p>
            
            <div class="idiom-grid" id="game-grid"></div>
            
            <div id="msg"></div>

            <div id="action-area" class="btn-group">
                <button class="btn btn-primary" id="submit-btn" onclick="checkAnswer()">æäº¤ç­”æ¡ˆ</button>
                <button class="btn btn-tool" id="clock-btn" onclick="useClockItem()">â³ å»¶æ™‚</button>
                <button class="btn btn-outline" onclick="giveUp()">æ”¾æ£„</button>
            </div>
        </div>
    </div>

    <!-- è§£ç­”å½ˆçª— Modal -->
    <div id="modal-explanation" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAndNext()">âœ•</button>
            <div class="modal-header">
                <h3 id="modal-title" style="margin:0; font-family: var(--serif); font-weight: 700;">è§£ç­”èˆ‡è§£æ</h3>
            </div>
            <div class="modal-body" id="exp-body">
                <!-- å…§å®¹å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeAndNext()">ç¹¼çºŒæŒ‘æˆ°</button>
            </div>
        </div>
    </div>

    <!-- ä¸­å ´ä¼‘æ¯ -->
    <div id="scene-rest" class="scene">
        <div class="game-card">
            <h2 style="color: var(--accent-blue); font-family: var(--serif); font-weight: 700;">â˜• ä¼‘æ¯æ™‚åˆ»</h2>
            <div class="art-intro">
                <span>èº«ç¶“ç™¾æˆ°ï¼Œæ–‡é‡‡æ–ç„¶ã€‚</span>
                <span>æ‚¨å·²é€£çºŒé—–éç¬¬ <span id="rest-milestone">10</span> é—œã€‚</span>
            </div>
            <div style="margin: 20px 0;">
                <div class="reward-badge">â¤ï¸ é«”åŠ›æ¢å¾©</div>
                <div class="reward-badge">â³ é“å…·è£œå……</div>
            </div>
            <button class="btn btn-primary" onclick="resumeGame()">æ•´è£å‡ºç™¼</button>
        </div>
    </div>

    <!-- çµæŸä»‹é¢ -->
    <div id="scene-end" class="scene">
        <div class="game-card">
            <h1 style="font-family: var(--serif); color: var(--accent-red); font-weight: 700; margin-bottom: 5px;">æŒ‘æˆ°çµæŸ</h1>
            
            <canvas id="result-canvas" width="600" height="450"></canvas>
            
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-outline" onclick="downloadResult()">ä¸‹è¼‰æˆå°±åœ–</button>
                <button class="btn btn-primary" onclick="location.reload()">å†è©¦ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

<script>
    let allIdioms = [];
    let currentQuestion = { baseWord: "", holeIndices: [], validAnswers: [], sortedList: [] };
    
    /**
     * userAnswersHistory æ”¹ç‚ºæŒ‰ã€ŒæŒ–ç©ºçµ„åˆã€ç´€éŒ„ç­”æ¡ˆ
     * Key: æ¨¡å¼ç‰¹å¾µ (å¦‚ "__ä¹‹_")
     * Value: Set (è©²æ¨¡å¼ä¸‹å·²ä½¿ç”¨çš„ç­”æ¡ˆ)
     */
    let userAnswersHistory = {}; 
    
    let score = 0, hp = 3, clocks = 3, playerName = "";
    let timerInterval, endTime;
    let isTransitioning = false, isGameActive = false, clockUsedThisRound = false;
    
    let startWidth = window.innerWidth;
    let startHeight = window.innerHeight;

    async function loadData() {
        try {
            const response = await fetch('https://idiom.strolltimes.com/dict_revised_2015_20240927.json');
            const data = await response.json();
            allIdioms = data.filter(item => item['å­—è©å'] && item['å­—è©å'].length === 4);
            allIdioms.sort(() => Math.random() - 0.5);
            document.getElementById('potential-count').innerText = "è³‡æ–™è¼‰å…¥å®Œæˆï¼Œéš¨æ™‚å¯ä»¥é–‹æˆ°ã€‚";
        } catch (e) {
            document.getElementById('potential-count').innerText = "è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚";
        }
    }
    loadData();

    const triggerAntiCheat = (msg = "ğŸš« å¿ƒæ€ä¸å°ˆï¼æ­¤é¡Œä½œå»¢ã€‚") => {
        if (isGameActive && !isTransitioning) {
            clearInterval(timerInterval);
            handleWrong(msg);
        }
    };

    document.addEventListener("visibilitychange", () => { if (document.hidden) triggerAntiCheat("ğŸš« é›¢é–‹ç•«é¢ï¼æ­¤é¡Œä½œå»¢ã€‚"); });
    window.addEventListener("blur", () => { triggerAntiCheat("ğŸš« å¤±å»ç„¦é»ï¼æ­¤é¡Œä½œå»¢ã€‚"); });
    
    window.addEventListener("resize", () => {
        if (Math.abs(window.innerWidth - startWidth) > 80 || Math.abs(window.innerHeight - startHeight) > 80) {
            triggerAntiCheat("ğŸš« è¦–çª—è®Šå‹•ï¼æ­¤é¡Œä½œå»¢ã€‚");
        }
    });

    function startGame() {
        if (allIdioms.length === 0) return alert("è³‡æ–™è¼‰å…¥ä¸­...");
        playerName = document.getElementById('player-name').value.trim() || "ç„¡åè‹±é›„";
        document.getElementById('display-name').innerText = playerName;
        
        startWidth = window.innerWidth;
        startHeight = window.innerHeight;
        
        userAnswersHistory = {}; // éŠæˆ²é–‹å§‹é‡ç½®æ­·å²ç´€éŒ„
        score = 0;
        hp = 3;
        clocks = 3;

        updateStatsDisplay();
        switchScene('scene-game');
        newQuestion();
    }

    function switchScene(id) {
        document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function updateStatsDisplay() {
        document.getElementById('score').innerText = score;
        document.getElementById('hp-display').innerText = "â¤ï¸ x" + hp;
        document.getElementById('clock-display').innerText = "â³ x" + clocks;
    }

    /**
     * ç”Ÿæˆç•¶å‰é¡Œç›®çš„æ¨¡å¼ç‰¹å¾µç¢¼
     * ä¾‹å¦‚ï¼šç§¦æ™‰ä¹‹å¥½ï¼ŒæŒ–ç©º [0,1,3] -> "__ä¹‹_"
     */
    function getCurrentPatternCode() {
        let code = "";
        for(let i=0; i<4; i++) {
            code += currentQuestion.holeIndices.includes(i) ? "_" : currentQuestion.baseWord[i];
        }
        return code;
    }

    function newQuestion() {
        if (hp <= 0) return endGame();
        isTransitioning = false; isGameActive = true; clockUsedThisRound = false;
        
        document.getElementById('msg').innerHTML = "";
        document.getElementById('action-area').style.display = "flex";
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('clock-btn').disabled = clocks <= 0;
        closeModal();

        let bestCandidate = null, attemptLimit = 300; 
        let minAnswers = 30, forceUnique = false;
        if (score >= 40) { minAnswers = 1; forceUnique = true; }
        else if (score >= 30) { minAnswers = 5; }
        else if (score >= 20) { minAnswers = 10; }
        else if (score >= 10) { minAnswers = 20; }

        while (attemptLimit--) {
            const target = allIdioms[Math.floor(Math.random() * allIdioms.length)];
            const word = target['å­—è©å'];
            
            // æ³¨æ„ï¼šé€™è£¡ä¸å†é™åˆ¶ã€Œé¡Œç›®ç¨®å­ã€ä¸èƒ½é‡è¤‡ï¼Œå› ç‚ºæŒ–ç©ºæ–¹å¼ä¸åŒå³è¦–ç‚ºæ–°é¡Œ
            
            let hIndices = [];
            if (forceUnique) { hIndices = [Math.floor(Math.random() * 4)]; }
            else {
                let numHoles = Math.floor(Math.random() * 3) + 1;
                let indices = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
                hIndices = indices.slice(0, numHoles).sort();
            }
            const matches = allIdioms.filter(item => {
                for(let j=0; j<4; j++) { if(!hIndices.includes(j) && item['å­—è©å'][j] !== word[j]) return false; }
                return true;
            });

            if (forceUnique) { if (matches.length === 1) { bestCandidate = { baseWord: word, holeIndices: hIndices, validAnswers: matches }; break; } }
            else { if (matches.length >= minAnswers) { bestCandidate = { baseWord: word, holeIndices: hIndices, validAnswers: matches }; break; } }
            
            if (!bestCandidate || Math.abs(matches.length - minAnswers) < Math.abs(bestCandidate.validAnswers.length - minAnswers)) {
                bestCandidate = { baseWord: word, holeIndices: hIndices, validAnswers: matches };
            }
        }

        currentQuestion = bestCandidate;
        document.getElementById('potential-count').innerText = forceUnique ? `å·”å³°å°æ±ºï¼šå”¯ä¸€è§£æ¨¡å¼` : `æ­¤çµ„åˆå…±æœ‰ ${currentQuestion.validAnswers.length} ç¨®å¯èƒ½`;
        renderGrid();
        startTimer(15000 + (currentQuestion.holeIndices.length * 5000));
    }

    function renderGrid() {
        const grid = document.getElementById('game-grid');
        grid.innerHTML = "";
        for (let i = 0; i < 4; i++) {
            const box = document.createElement('div');
            box.className = "char-box";
            if (currentQuestion.holeIndices.includes(i)) {
                box.innerHTML = `<input type="text" id="ans-${i}" class="game-input" data-idx="${i}" autocomplete="off">`;
            } else { box.innerText = currentQuestion.baseWord[i]; }
            grid.appendChild(box);
        }
        
        const inputs = document.querySelectorAll('.game-input');
        if(inputs[0]) inputs[0].focus();
        
        inputs.forEach((input, idx) => {
            let isComposing = false;
            input.addEventListener('compositionstart', () => { isComposing = true; });
            input.addEventListener('compositionend', () => {
                isComposing = false;
                if (input.value && inputs[idx+1]) { inputs[idx+1].focus(); }
            });
            input.addEventListener('input', () => {
                if (!isComposing && input.value && inputs[idx+1]) { inputs[idx+1].focus(); }
            });
            input.onkeydown = (e) => {
                if(e.key === 'Backspace' && !input.value && inputs[idx-1]) inputs[idx-1].focus();
                if(e.key === 'Enter') checkAnswer();
            };
        });
    }

    function startTimer(duration) {
        clearInterval(timerInterval);
        const start = Date.now();
        endTime = start + duration;
        timerInterval = setInterval(() => {
            const now = Date.now();
            const remain = Math.max(0, endTime - now);
            const progress = (remain / duration) * 100;
            document.getElementById('timer-bar').style.width = progress + "%";
            if (remain <= 0) { clearInterval(timerInterval); handleWrong("âŒ› æ™‚é–“åˆ°ï¼"); }
        }, 50);
    }

    function useClockItem() {
        if (clocks <= 0 || clockUsedThisRound || !isGameActive) return;
        clocks--; clockUsedThisRound = true;
        updateStatsDisplay();
        endTime += 15000;
        document.getElementById('msg').innerHTML = "<span style='color:var(--accent-gold)'>â³ æ™‚å…‰å»¶é•· 15 ç§’</span>";
        document.getElementById('clock-btn').disabled = true;
    }

    function checkAnswer() {
        if (isTransitioning) return;
        const inputs = document.querySelectorAll('.game-input');
        let attempt = "", complete = true;
        for(let i=0; i<4; i++) {
            if(currentQuestion.holeIndices.includes(i)) {
                const val = document.getElementById(`ans-${i}`).value.trim();
                if(!val) complete = false;
                attempt += val;
            } else { attempt += currentQuestion.baseWord[i]; }
        }
        if(!complete) return;

        const found = allIdioms.find(item => item['å­—è©å'] === attempt);
        
        if (found) {
            const word = found['å­—è©å'];
            const pattern = getCurrentPatternCode();
            
            // æª¢æŸ¥è©²ã€Œç‰¹å®šæŒ–ç©ºæ¨¡å¼ã€ä¸‹æ˜¯å¦å·²ç¶“ç”¨éé€™å€‹ç­”æ¡ˆ
            if (userAnswersHistory[pattern] && userAnswersHistory[pattern].has(word)) {
                document.getElementById('msg').innerHTML = `<span style="color:orange">âš ï¸ åœ¨æ­¤å¡«ç©ºçµ„åˆä¸‹ï¼Œã€Œ${word}ã€å·²ç”¨éï¼</span>`;
                return;
            }

            // è‹¥ç‚ºæ­£ç¢ºä¸”åœ¨è©²æ¨¡å¼ä¸‹å°šæœªç”¨é
            clearInterval(timerInterval);
            isTransitioning = true; 
            isGameActive = false;
            
            score++; 
            
            // ç´€éŒ„åˆ°è©²æ¨¡å¼ä¸‹çš„æ­·å²ç´€éŒ„ä¸­
            if (!userAnswersHistory[pattern]) userAnswersHistory[pattern] = new Set();
            userAnswersHistory[pattern].add(word);
            
            updateStatsDisplay();
            document.getElementById('msg').innerHTML = `<span style="color:green">âœ¨ æ­£ç¢ºï¼š${attempt}</span>`;
            showExplanations(found, true);
        } else { 
            clearInterval(timerInterval);
            isTransitioning = true; 
            isGameActive = false;
            handleWrong("âŒ æŸ¥ç„¡æ­¤è©", attempt); 
        }
    }

    function handleWrong(reason, attempt) {
        clearInterval(timerInterval);
        isTransitioning = true; isGameActive = false;
        hp--; updateStatsDisplay();
        document.getElementById('msg').innerHTML = `<span style="color:var(--accent-red)">${reason}</span>`;
        showExplanations(null, false);
    }

    function showExplanations(userFound, isSuccess) {
        const modal = document.getElementById('modal-explanation');
        const body = document.getElementById('exp-body');
        const title = document.getElementById('modal-title');
        
        let list = [...currentQuestion.validAnswers];
        if (userFound) { list = [userFound, ...list.filter(a => a['å­—è©å'] !== userFound['å­—è©å'])]; }
        
        title.innerText = isSuccess ? "âœ… æ­£ç¢ºè§£é–" : "ğŸ’¡ å¯æƒœäº†ï¼Œæ­£ç¢ºç­”æ¡ˆåƒè€ƒï¼š";
        
        let html = "";
        list.forEach(item => {
            const cleanDef = item['é‡‹ç¾©'].replace(/<[^>]*>/g, '').slice(0, 150);
            html += `<div class="idiom-list-item">
                        <span class="idiom-title">ã€${item['å­—è©å']}ã€‘</span>
                        <div class="idiom-def">${cleanDef}...</div>
                     </div>`;
        });
        
        body.innerHTML = html;
        modal.style.display = "flex";
    }

    function closeModal() {
        document.getElementById('modal-explanation').style.display = "none";
    }

    function closeAndNext() {
        closeModal();
        handleNextStep();
    }

    function handleNextStep() {
        if (hp <= 0) {
            endGame();
            return;
        }
        if (score > 0 && score % 10 === 0) { 
            showRestScene(); 
        } else { 
            newQuestion(); 
        }
    }

    function showRestScene() { document.getElementById('rest-milestone').innerText = score; switchScene('scene-rest'); }
    function resumeGame() { hp = Math.min(5, hp + 1); clocks++; updateStatsDisplay(); switchScene('scene-game'); newQuestion(); }
    function giveUp() { if (!isGameActive) return; handleWrong("å·²æ”¾æ£„"); }
    
    function getRankInfo(s) {
        if (s >= 50) return { title: "ã€ç­†è½é©šé¢¨é›¨ã€‘", desc: "ç™»å³°é€ æ¥µï¼Œæ› å¤çµ•å€«ã€‚" };
        if (s >= 40) return { title: "ã€æ‰é«˜å…«æ–—ã€‘", desc: "é©šæ‰çµ•è±”ï¼Œç¿°æ—åå®¿ã€‚" };
        if (s >= 30) return { title: "ã€èƒ¸è—éŒ¦ç¹¡ã€‘", desc: "åšå¤é€šä»Šï¼Œå­¸å¯Œäº”è»Šã€‚" };
        if (s >= 20) return { title: "ã€æ–ç„¶æˆç« ã€‘", desc: "è¾­è—»æ¸…éº—ï¼Œæ‰æ°£åˆå±•ã€‚" };
        if (s >= 10) return { title: "ã€ç•¥é€šæ–‡å¢¨ã€‘", desc: "ç­†è€•ä¸è¼Ÿï¼Œæ¼¸å…¥ä½³å¢ƒã€‚" };
        return { title: "ã€å°‹ç« æ‘˜å¥ã€‘", desc: "å­—æµ·æµ®æ²ˆï¼ŒçŒ¶éœ€ç ¥ç¤ªã€‚" };
    }

    function endGame() { 
        isGameActive = false; 
        clearInterval(timerInterval); 
        closeModal(); 
        switchScene('scene-end'); 
        drawResult(); 
    }

    function drawResult() {
        const canvas = document.getElementById('result-canvas');
        const ctx = canvas.getContext('2d');
        const rank = getRankInfo(score);
        
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 600, 450);
        ctx.strokeStyle = "#eee"; ctx.lineWidth = 15; ctx.strokeRect(0, 0, 600, 450);
        
        ctx.fillStyle = "#2c3e50"; ctx.textAlign = "center";
        ctx.font = "600 30px 'Noto Serif TC'"; ctx.fillText("æˆèªæ“‚å°æˆå°±æ¦œ", 300, 80);
        
        ctx.font = "700 120px 'Noto Serif TC'"; ctx.fillStyle = "#a63d33"; ctx.fillText(`${score}`, 300, 220);
        
        ctx.font = "600 34px 'Noto Serif TC'"; ctx.fillStyle = "#2c3e50"; ctx.fillText(rank.title, 300, 315);
        
        ctx.font = "italic 22px 'Noto Serif TC'"; ctx.fillStyle = "#7f8c8d"; ctx.fillText(rank.desc, 300, 360);
        
        ctx.font = "600 20px 'Noto Serif TC'"; ctx.fillStyle = "#34495e"; ctx.fillText(`æŒ‘æˆ°è€…ï¼š${playerName}`, 300, 410);
    }

    function downloadResult() {
        const link = document.createElement('a');
        link.download = `rank_${playerName}.png`;
        link.href = document.getElementById('result-canvas').toDataURL();
        link.click();
    }
</script>
</body>
</html>